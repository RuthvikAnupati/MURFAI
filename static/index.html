<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mika Voice Agent</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="icon" href="/static/favicon.ico" type="image/x-icon" />

<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(-45deg, #d1fae5, #bfdbfe, #fce7f3, #fef3c7);
    background-size: 400% 400%;
    animation: gradientBG 18s ease infinite;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Video fixed inside header, top-left */
  .top-left-video {
    position: fixed;
    top: 10px;
    left: 10px;
    width: 90px;
    height: 90px;
    z-index: 1001;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(6px);
    pointer-events: none;
  }
  .top-left-video video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  header {
    background: rgba(255, 255, 255, 0.35);
    backdrop-filter: blur(12px);
    box-shadow: 0 3px 12px rgba(0,0,0,0.05);
    padding: 1rem;
    text-align: center;
    border-bottom: 2px solid rgba(255,255,255,0.5);
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
    color: #1e3a8a;
  }
  .header-buttons {
    margin-top: 0.5rem;
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  .header-buttons button {
    background: linear-gradient(135deg, #93c5fd, #60a5fa);
    border: none;
    color: white;
    padding: 0.5rem 1.2rem;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: transform 0.2s, background 0.3s;
  }
  .header-buttons button:hover {
    transform: translateY(-2px);
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
  }
  .clear-history {
    background: linear-gradient(135deg, #fcd34d, #fbbf24);
  }
  .clear-history:hover {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
  }
  main {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  .app-card {
    width: 100%;
    max-width: 850px;
    background: rgba(255,255,255,0.4);
    backdrop-filter: blur(14px);
    border-radius: 20px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.1);
    padding: 1.8rem;
    display: flex;
    flex-direction: column;
    position: relative;
    border: 2px solid rgba(255,255,255,0.6);
  }
  #recordButton {
    margin: 0 auto;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
    color: white;
    font-size: 1.8em;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(96,165,250,0.4);
    transition: transform 0.2s ease;
  }
  #recordButton:hover { transform: scale(1.07); }
  #recordButton.recording {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.6); }
    70% { box-shadow: 0 0 0 25px rgba(239,68,68,0); }
    100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
  }
  #llmStatus { font-size: 0.9rem; margin-top: 0.6rem; }
  .chat-container {
    margin-top: 20px;
    background: rgba(255,255,255,0.55);
    border-radius: 15px;
    padding: 1rem;
    height: 300px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .chat-message {
    max-width: 75%;
    padding: 10px 16px;
    border-radius: 16px;
    line-height: 1.4;
    white-space: pre-wrap;
  }
  .chat-message.user {
    background: linear-gradient(135deg, #93c5fd, #60a5fa);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 5px;
  }
  .chat-message.agent {
    background: rgba(255,255,255,0.85);
    color: #1e293b;
    align-self: flex-start;
    border-bottom-left-radius: 5px;
  }
  /* Stop button */
  #stopButton {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 35px;
    height: 35px;
    background: red;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    display: none;
  }
  footer {
    background: rgba(255, 255, 255, 0.3);
    text-align: center;
    padding: 0.8rem;
    font-size: 0.85rem;
    color: #374151;
    border-top: 2px solid rgba(255,255,255,0.5);
  }
  .how-to-use-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
    color: white;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 25px;
    cursor: pointer;
    font-size: 0.9rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    transition: transform 0.2s;
    z-index: 1000;
  }
  .how-to-use-btn:hover { transform: scale(1.05); }
  .how-to-use-popup {
    display: none;
    position: fixed;
    bottom: 70px;
    right: 20px;
    background: rgba(255,255,255,0.95);
    border-radius: 12px;
    padding: 1rem;
    max-width: 300px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    z-index: 1000;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<header>
  <div class="top-left-video">
    <video autoplay loop muted playsinline>
      <source src="../static/v2.mp4" type="video/mp4">
    </video>
  </div>
  <h1>üé§ Mika Voice Agent</h1>
  <div class="header-buttons">
    <button id="newSession">üÜï New Session</button>
    <button id="clearHistory" class="clear-history">üóëÔ∏è Clear History</button>
  </div>
</header>

<main>
  <div class="app-card">
    <button id="recordButton">üéôÔ∏è</button>
    <button id="stopButton">‚ñ†</button>
    <div id="llmStatus" class="status-text text-muted text-center">Idle</div>
    <audio id="llmAudio"></audio>
    <div class="chat-container" id="chatHistory"></div>
  </div>
</main>

<button class="how-to-use-btn" id="howToUseBtn">üìå How to Use</button>
<div class="how-to-use-popup" id="howToUsePopup">
  <h5>üìå How to Use Mika Voice Agent</h5>
  <ol>
    <li>Click üéôÔ∏è to start recording.</li>
    <li>Speak clearly, then click üéôÔ∏è again.</li>
    <li>Wait for Mika's reply (text + audio).</li>
    <li>üÜï starts a new session.</li>
    <li>üóëÔ∏è clears chat history.</li>
    <li>Press the red ‚óè to stop the reply instantly.</li>
  </ol>
</div>

<footer>
  &copy; 2025 Mika AI Voice Agent | Designed for ‚ù§Ô∏è 
  <br>
  <small style="color:#6b7280; font-style: italic;">
    "Every great conversation starts with a single word."
  </small>
</footer>

<script>
  const sessionId = Date.now();
  const recordButton = document.getElementById("recordButton");
  const llmStatus = document.getElementById("llmStatus");
  const llmAudio = document.getElementById("llmAudio");
  const chatHistoryDiv = document.getElementById("chatHistory");
  const newSessionBtn = document.getElementById("newSession");
  const clearHistoryBtn = document.getElementById("clearHistory");
  const howToUseBtn = document.getElementById("howToUseBtn");
  const howToUsePopup = document.getElementById("howToUsePopup");
  const FALLBACK_MSG = "I'm having trouble connecting right now.";
  let mediaRecorder, audioChunks = [];
  let isRecording = false;
  let isAgentSpeaking = false;

  function addMessage(text, role) {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("chat-message", role);
    msgDiv.textContent = text;
    chatHistoryDiv.appendChild(msgDiv);
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
  }

  recordButton.addEventListener("click", async () => {
    if (isAgentSpeaking) {
      llmAudio.pause();
      llmAudio.src = "";
      isAgentSpeaking = false;
      resetMicButton();
      llmStatus.textContent = "‚èπ Stopped.";
      return;
    }

    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = sendRecording;
        mediaRecorder.start();
        isRecording = true;
        recordButton.classList.add("recording");
        llmStatus.textContent = "Recording...";
      } catch {
        alert("Microphone access denied.");
      }
    } else {
      mediaRecorder.stop();
      isRecording = false;
      recordButton.classList.remove("recording");
      llmStatus.textContent = "Processing...";
    }
  });

  async function sendRecording() {
    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
    const formData = new FormData();
    formData.append("file", audioBlob, "recording.webm");

    try {
      const res = await fetch(`/agent/chat/${sessionId}`, { method: "POST", body: formData });
      if (!res.ok) throw new Error("LLM Agent API failed");
      const result = await res.json();

      addMessage(result.transcription || "üé§ Voice message", "user");
      addMessage(result.llm_response || FALLBACK_MSG, "agent");

      if (result.audio_urls?.length) {
        startAgentSpeaking();
        playAudioSequence(result.audio_urls);
        llmStatus.textContent = "üîä Speaking...";
      }
    } catch (err) {
      console.error(err);
      addMessage("üé§ Voice message", "user");
      addMessage(FALLBACK_MSG, "agent");
      speakFallback();
      llmStatus.textContent = "‚ùå Agent failed.";
    }
  }

  function playAudioSequence(urls) {
    let index = 0;
    llmAudio.src = urls[index];
    llmAudio.play();
    llmAudio.onended = () => {
      index++;
      if (index < urls.length) {
        llmAudio.src = urls[index];
        llmAudio.play();
      } else {
        stopAgentSpeaking();
      }
    };
  }

  function startAgentSpeaking() {
    isAgentSpeaking = true;
    recordButton.textContent = "‚ñ†";
    recordButton.style.background = "linear-gradient(135deg, #ef4444, #dc2626)";
  }

  function stopAgentSpeaking() {
    isAgentSpeaking = false;
    resetMicButton();
    llmStatus.textContent = "‚úÖ Complete!";
  }

  function resetMicButton() {
    recordButton.textContent = "üéôÔ∏è";
    recordButton.style.background = "linear-gradient(135deg, #60a5fa, #3b82f6)";
  }

  function speakFallback() {
    window.speechSynthesis.speak(new SpeechSynthesisUtterance(FALLBACK_MSG));
  }

  newSessionBtn.addEventListener("click", () => {
    chatHistoryDiv.innerHTML = "";
    llmStatus.textContent = "Idle";
  });

  clearHistoryBtn.addEventListener("click", () => {
    chatHistoryDiv.innerHTML = "";
  });

  howToUseBtn.addEventListener("click", () => {
    howToUsePopup.style.display = 
      howToUsePopup.style.display === "block" ? "none" : "block";
  });
</script>

</body>
</html>
